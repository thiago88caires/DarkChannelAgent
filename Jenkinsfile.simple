// =================================================================
// Dark Channel Agent - Jenkinsfile Simples
// Pipeline b√°sico para Jenkins sem depend√™ncia de SCM
// =================================================================

pipeline {
    agent any
    
    environment {
        DOCKER_BUILDKIT = '1'
        COMPOSE_DOCKER_CLI_BUILD = '1'
        APP_NAME = 'dark-channel-agent'
        APP_ENV = 'production'
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'MINUTES')
        disableConcurrentBuilds()
    }
    
    stages {
        stage('Preparation') {
            steps {
                script {
                    echo "üöÄ Iniciando build da Dark Channel Agent..."
                    
                    sh '''
                        echo "=== Informa√ß√µes do Ambiente ==="
                        echo "Workspace: $(pwd)"
                        echo "Usu√°rio: $(whoami)"
                        echo "Data: $(date)"
                        echo "Arquivos no workspace:"
                        ls -la
                        echo "================================"
                    '''
                }
            }
        }
        
        stage('Environment Check') {
            steps {
                script {
                    echo "üîç Verificando ambiente..."
                    
                    sh '''
                        echo "Verificando arquivos necess√°rios..."
                        
                        if [ ! -f "docker-compose.yml" ]; then
                            echo "‚ùå docker-compose.yml n√£o encontrado!"
                            exit 1
                        fi
                        
                        if [ ! -f "build.sh" ]; then
                            echo "‚ùå build.sh n√£o encontrado!"
                            exit 1
                        fi
                        
                        if [ ! -f "backend/package.json" ]; then
                            echo "‚ùå backend/package.json n√£o encontrado!"
                            exit 1
                        fi
                        
                        if [ ! -f "frontend/package.json" ]; then
                            echo "‚ùå frontend/package.json n√£o encontrado!"
                            exit 1
                        fi
                        
                        if [ ! -f ".env" ]; then
                            echo "‚ö†Ô∏è  Arquivo .env n√£o encontrado!"
                            echo "Criando arquivo .env b√°sico..."
                            # Criar um .env b√°sico para o build
                            cat > .env << 'EOF'
# Configura√ß√µes b√°sicas para build
POSTGRES_PASSWORD=postgres123
JWT_SECRET=your-super-secret-jwt-token-here
SUPABASE_ANON_KEY=your-anon-key-here
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here
SUPABASE_PUBLIC_URL=http://localhost:54321
SUPABASE_INTERNAL_URL=http://supabase-gateway
SITE_URL=http://localhost:3000
API_EXTERNAL_URL=http://localhost:54321
PGRST_DB_SCHEMAS=public
DISABLE_SIGNUP=false
ENABLE_EMAIL_SIGNUP=true
ENABLE_EMAIL_AUTOCONFIRM=true
ENABLE_PHONE_SIGNUP=false
ENABLE_PHONE_AUTOCONFIRM=false
JWT_EXPIRY=3600
SMTP_ADMIN_EMAIL=admin@example.com
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
SMTP_SENDER_NAME=DarkChannelAgent
N8N_BASE_URL=http://n8n:5678
N8N_WEBHOOK_SCREENPLAY_URL=http://n8n:5678/webhook/screenplay
N8N_WEBHOOK_VIDEO_URL=http://n8n:5678/webhook/video
N8N_CALLBACK_SECRET=your-callback-secret
PAYMENT_PROVIDER=stripe
STRIPE_SECRET_KEY=sk_test_your_stripe_secret_key
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret
CREDITS_PRICE_CENTS=3000
ALLOW_ANON=true
ALLOW_ANON_ADMIN=false
ADDITIONAL_REDIRECT_URLS=http://localhost:3000
EOF
                        fi
                        
                        echo "‚úÖ Verifica√ß√£o de arquivos conclu√≠da"
                    '''
                    
                    sh '''
                        echo "Verificando Docker..."
                        docker --version
                        if command -v docker-compose >/dev/null 2>&1; then
                            docker-compose --version
                        elif docker compose version >/dev/null 2>&1; then
                            docker compose version
                            echo "Usando 'docker compose' ao inv√©s de 'docker-compose'"
                        else
                            echo "‚ùå Docker Compose n√£o encontrado!"
                            exit 1
                        fi
                        echo "‚úÖ Docker verificado"
                    '''
                }
            }
        }
        
        stage('Build Application') {
            steps {
                script {
                    echo "üèóÔ∏è Construindo aplica√ß√£o..."
                    
                    sh '''
                        # Dar permiss√µes de execu√ß√£o
                        chmod +x build.sh
                        
                        # Executar o script de build
                        ./build.sh
                    '''
                }
            }
        }
        
        stage('Health Check') {
            steps {
                script {
                    echo "üè• Executando verifica√ß√µes de sa√∫de..."
                    
                    sleep(time: 30, unit: 'SECONDS')
                    
                    sh '''
                        echo "Verificando sa√∫de dos servi√ßos..."
                        
                        # Fun√ß√£o para testar endpoint
                        test_endpoint() {
                            local url=$1
                            local name=$2
                            local max_attempts=10
                            local attempt=1
                            
                            while [ $attempt -le $max_attempts ]; do
                                echo "Tentando conectar com $name (tentativa $attempt/$max_attempts)..."
                                if curl -f "$url" >/dev/null 2>&1; then
                                    echo "‚úÖ $name est√° respondendo"
                                    return 0
                                fi
                                sleep 5
                                ((attempt++))
                            done
                            
                            echo "‚ùå $name n√£o est√° respondendo ap√≥s $max_attempts tentativas"
                            return 1
                        }
                        
                        # Testar endpoints
                        test_endpoint "http://localhost:8080/health" "Backend"
                        test_endpoint "http://localhost:3000" "Frontend"
                        test_endpoint "http://localhost:54321/health" "Supabase"
                        
                        echo "üéâ Todos os servi√ßos est√£o funcionando!"
                    '''
                }
            }
        }
        
        stage('Deploy Status') {
            steps {
                script {
                    echo "üöÄ Mostrando status da aplica√ß√£o..."
                    
                    sh '''
                        echo "=== Status Final da Aplica√ß√£o ==="
                        if command -v docker-compose >/dev/null 2>&1; then
                            docker-compose ps
                        else
                            docker compose ps
                        fi
                        echo ""
                        echo "URLs de acesso:"
                        echo "  Frontend:        http://localhost:3000"
                        echo "  Backend API:     http://localhost:8080"
                        echo "  Supabase:        http://localhost:54321"
                        echo "  Supabase Studio: http://localhost:54323"
                        echo ""
                        echo "üéâ Deploy conclu√≠do com sucesso!"
                    '''
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "üßπ Executando limpeza final..."
                
                sh '''
                    echo "Coletando logs dos containers..."
                    mkdir -p logs
                    if command -v docker-compose >/dev/null 2>&1; then
                        docker-compose logs > logs/docker-compose.log 2>&1 || true
                    else
                        docker compose logs > logs/docker-compose.log 2>&1 || true
                    fi
                '''
                
                archiveArtifacts artifacts: 'logs/**', allowEmptyArchive: true
            }
        }
        
        success {
            script {
                echo "‚úÖ Pipeline executado com sucesso!"
                
                sh '''
                    echo "üéâ Build conclu√≠do com sucesso!"
                    echo "Data: $(date)"
                    echo "Workspace: $(pwd)"
                '''
            }
        }
        
        failure {
            script {
                echo "‚ùå Pipeline falhou!"
                
                sh '''
                    echo "=== Informa√ß√µes de Debug ==="
                    echo "Docker containers:"
                    docker ps -a || true
                    echo ""
                    echo "Docker images:"
                    docker images || true
                    echo ""
                    echo "Docker compose status:"
                    if command -v docker-compose >/dev/null 2>&1; then
                        docker-compose ps || true
                    else
                        docker compose ps || true
                    fi
                '''
                
                sh '''
                    echo "Fazendo cleanup de emerg√™ncia..."
                    if command -v docker-compose >/dev/null 2>&1; then
                        docker-compose down || true
                    else
                        docker compose down || true
                    fi
                '''
            }
        }
        
        cleanup {
            script {
                echo "üóëÔ∏è Limpeza final do workspace..."
                
                // Opcional: limpeza adicional se necess√°rio
                // sh '''
                //     docker system prune -f || true
                // '''
            }
        }
    }
}